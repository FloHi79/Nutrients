import React, { useState } from 'react';
import { 
  Heart, Activity, Brain, Battery, Moon, Utensils, Thermometer, 
  ChevronRight, CheckCircle, AlertCircle, Droplet, ArrowRight, 
  Info, RotateCcw, MessageSquare, Sun, Dumbbell, Wine, Sparkles, Loader2, Pill,
  GraduationCap, Microscope
} from 'lucide-react';

// --- API KONFIGURATION ---
const apiKey = "AIzaSyBDJ3qmA8dFqDJpKxDzWfnA99B44aq0ep4"; 

// --- DATENBASIS ---
const questions = [
  // --- BASIS ---
  {
    id: 1,
    text: "Wie alt sind Sie?",
    options: [
      { label: "Unter 30 / Jugendliche(r)", value: "young" },
      { label: "30 - 45", value: "middle" },
      { label: "46 - 60 (Wechseljahre/Andropause)", value: "menopause" },
      { label: "Über 60", value: "senior" }
    ]
  },
  {
    id: 2,
    text: "Welches Geschlecht haben Sie?",
    options: [
      { label: "Weiblich", value: "female" },
      { label: "Männlich", value: "male" }
    ]
  },
  {
    id: 3,
    text: "Was ist Ihr primäres Ziel? (Mehrfachauswahl)",
    multi: true,
    options: [
      { label: "Energie & Post-Viral-Recovery", value: "energy_youth" },
      { label: "Prävention & gesund alt werden", value: "prevention" },
      { label: "Leistungssteigerung (Sport/Kognition)", value: "performance" },
      { label: "Linderung chronischer Beschwerden", value: "healing" },
      { label: "Gewichtsreduktion / Stoffwechsel", value: "weight" }
    ]
  },
  // --- ENERGIE & STRESS ---
  {
    id: 4,
    text: "Energielevel beschreiben:",
    options: [
      { label: "Top fit", value: "high" },
      { label: "Geht so, Mittagstief", value: "medium" },
      { label: "Dauerhaft erschöpft / Antriebslos", value: "low" },
      { label: "Morgens müde, abends wach", value: "adrenal" }
    ]
  },
  {
    id: 13,
    text: "Stresslevel im Alltag:",
    options: [
      { label: "Niedrig", value: "low" },
      { label: "Mittel", value: "medium" },
      { label: "Hoch (Prüfungsstress/Dauerstrom)", value: "high" }
    ]
  },
  // --- LEBENSSTIL ---
  {
    id: 5,
    text: "Ernährungsweise:",
    options: [
      { label: "Mischkost (Alles)", value: "omni" },
      { label: "Vegetarisch", value: "veg" },
      { label: "Vegan", value: "vegan" },
      { label: "Low Carb / Keto", value: "keto" },
      { label: "Fast Food / Unregelmäßig", value: "junk" }
    ]
  },
  {
    id: 16,
    text: "Fischkonsum (Seefisch):",
    options: [
      { label: "Mindestens 2x pro Woche", value: "often" },
      { label: "Ab und zu / Selten", value: "rare" },
      { label: "Nie / Ich mag keinen Fisch", value: "never" }
    ]
  },
  {
    id: 17,
    text: "Sportpensum:",
    options: [
      { label: "Kein Sport / Schulsport", value: "none" },
      { label: "Moderat / Hobby", value: "moderate" },
      { label: "Leistungssport / Intensiv", value: "athlete" }
    ]
  },
  {
    id: 18,
    text: "Sonnenexposition (ohne Creme) im Sommer:",
    options: [
      { label: "Viel", value: "high" },
      { label: "Mittel", value: "medium" },
      { label: "Wenig (Drinnenhocker/Gaming/Büro)", value: "low" }
    ]
  },
  {
    id: 19,
    text: "Rauchen:",
    options: [
      { label: "Nein", value: "no" },
      { label: "Gelegentlich", value: "occasional" },
      { label: "Regelmäßig", value: "smoker" }
    ]
  },
  {
    id: 20,
    text: "Alkohol:",
    options: [
      { label: "Nein / Selten", value: "no" },
      { label: "Mäßig", value: "moderate" },
      { label: "Regelmäßig", value: "high" }
    ]
  },
  // --- SYMPTOME ---
  {
    id: 6,
    text: "Schlaf & Träume:",
    multi: true,
    options: [
      { label: "Schlafe gut, erinnere mich an Träume", value: "no", exclusive: true },
      { label: "Einschlafprobleme (Gedankenkarussell)", value: "sleep_onset" },
      { label: "Durchschlafprobleme", value: "sleep_maintain" },
      { label: "Ich erinnere mich fast nie an Träume", value: "no_dreams" }
    ]
  },
  {
    id: 7,
    text: "Haut/Haare/Nägel:",
    multi: true,
    options: [
      { label: "Alles gut", value: "no", exclusive: true },
      { label: "Akne / Unreine Haut", value: "acne" },
      { label: "Haarausfall", value: "hair" },
      { label: "Brüchige Nägel / Weiße Flecken", value: "nails" },
      { label: "Trockene Haut / Neurodermitis", value: "skin" },
      { label: "Dehnungsstreifen", value: "stretchmarks" }
    ]
  },
  {
    id: 8,
    text: "Immunsystem & Infekte:",
    multi: true, 
    options: [
      { label: "Stabil / Selten krank", value: "good", exclusive: true },
      { label: "Häufige Infekte", value: "weak" },
      { label: "Hatte schwere Infektion (EBV, Covid, Grippe...)", value: "postviral" },
      { label: "Autoimmunerkrankung (Hashimoto etc.)", value: "autoimmune" }
    ]
  },
  {
    id: 9,
    text: "Muskeln/Gelenke:",
    multi: true,
    options: [
      { label: "Keine Beschwerden", value: "no", exclusive: true },
      { label: "Überbewegliche Gelenke", value: "hypermobile" },
      { label: "Krämpfe / Verspannungen", value: "muscle" },
      { label: "Gelenkschmerzen / Arthrose", value: "joint" }
    ]
  },
  {
    id: 21,
    text: "Zähne/Zahnfleisch:",
    options: [
      { label: "Gut", value: "no" },
      { label: "Zahnfleischbluten", value: "gums" },
      { label: "Kariesanfälligkeit / schlechte Substanz", value: "teeth" }
    ]
  },
  {
    id: 22,
    text: "Kälteempfinden:",
    options: [
      { label: "Normal", value: "normal" },
      { label: "Friere leicht (kalte Hände/Füße)", value: "cold" },
      { label: "Mir ist eher zu warm", value: "hot" }
    ]
  },
  {
    id: 23,
    text: "Nachtsehen:",
    options: [
      { label: "Normal", value: "no" },
      { label: "Schlecht im Dunkeln", value: "nightblind" }
    ]
  },
  {
    id: 10,
    text: "Stimmungslage & Wahrnehmung:",
    multi: true,
    options: [
      { label: "Ausgeglichen", value: "balanced", exclusive: true },
      { label: "Hochsensibel / Lärmempfindlich", value: "hsp" },
      { label: "Ängstlich / Depressiv", value: "depressive" },
      { label: "Stimmungsschwankungen", value: "moody" },
      { label: "ADHS / Innere Unruhe", value: "adhs" }
    ]
  },
  {
    id: 11,
    text: "Schilddrüse:",
    options: [
      { label: "Unauffällig / Unbekannt", value: "no" },
      { label: "Unterfunktion / Hashimoto", value: "hypo" },
      { label: "Überfunktion", value: "hyper" }
    ]
  },
  {
    id: 12,
    text: "Verdauung & Übelkeit:",
    multi: true,
    options: [
      { label: "Gut", value: "no", exclusive: true },
      { label: "Morgendliche Übelkeit / Kein Frühstückshunger", value: "morning_nausea" },
      { label: "Blähbauch / Reizdarm", value: "bloating" },
      { label: "Unverträglichkeiten (Fruktose/Histamin/Gluten)", value: "intolerance" }
    ]
  },
  {
    id: 24,
    text: "Familiäre Vorbelastung:",
    multi: true,
    options: [
      { label: "Keine", value: "no", exclusive: true },
      { label: "Schilddrüse / Hashimoto", value: "fam_thyroid" },
      { label: "Diabetes", value: "diabetes" },
      { label: "Psychische Erkrankungen", value: "fam_psyche" },
      { label: "Herz/Kreislauf", value: "heart" }
    ]
  },
  {
    id: 14,
    text: "Medikamente:",
    multi: true,
    hasFreeText: true,
    freeTextPlaceholder: "Sonstige (z.B. Antibiotika, Antidepressiva)...",
    options: [
      { label: "Keine", value: "no", exclusive: true },
      { label: "Antibabypille", value: "pill" },
      { label: "Säureblocker (PPI)", value: "ppi" },
      { label: "Antiallergika", value: "allergy" },
      { label: "Schilddrüsenhormone", value: "lthyrox" }
    ]
  },
  {
    id: 15,
    text: "Kognitive Leistung:",
    multi: true,
    options: [
      { label: "Klarer Kopf", value: "no", exclusive: true },
      { label: "Konzentrationsstörungen", value: "focus" },
      { label: "Brain Fog (Nebel)", value: "fog" },
      { label: "Vergesslichkeit", value: "memory" }
    ]
  },
  {
    id: 25,
    text: "Freitext / Sonstiges:",
    type: "text",
    placeholder: "Beschreiben Sie hier alles Weitere (z.B. 'Ich vertrage Stress überhaupt nicht', 'Nach dem Sport tagelang erschöpft'...)"
  }
];

// LABORWERTE-KATALOG (Reine Diagnostik, keine Therapieempfehlung im Text!)
const labParameters = {
  // BASIS
  vitaminD: { name: "Vitamin D3 (25-OH)", material: "Serum", reason: "Bestimmung des aktuellen Versorgungsstatus. Basiswert für Immunsystem & Knochen." },
  magnesium: { name: "Magnesium", material: "Vollblut (Heparin/EDTA)", reason: "Bestimmung der intrazellulären Versorgung. Serumwerte schließen Mangel nicht aus." },
  zink: { name: "Zink", material: "Vollblut (EDTA)", reason: "Überprüfung der zellulären Speicher (Zink ist primär intrazellulär). Wichtig bei Haut & Immunsystem." },
  selen: { name: "Selen", material: "Vollblut (EDTA)", reason: "Beurteilung der Versorgungslage (DE ist Mangelgebiet). Relevanter Cofaktor für Schilddrüsenenzyme." },
  ferritin: { name: "Ferritin", material: "Serum", reason: "Messung der Eisenspeicher. Wichtig zur Abklärung von Müdigkeit und Haarausfall." },
  homocystein: { name: "Homocystein", material: "Serum (Spezialröhrchen)", reason: "Funktionsmarker zur Beurteilung der Vitamin B6/B12/Folsäure-Versorgung." },
  
  // SPEZIAL POST-VIRAL / JUGEND
  ebv: { name: "EBV-Antikörper (VCA-IgG/IgM, EBNA-1)", material: "Serum", reason: "Abklärung einer möglichen Reaktivierung des Epstein-Barr-Virus bei chronischer Erschöpfung." },
  b6: { name: "Vitamin B6 (Bioaktiv P5P)", material: "EDTA-Blut", reason: "Bestimmung des aktiven B6-Spiegels. Wichtig bei Verdacht auf Stoffwechselstörungen (HPU) oder Pilleneinnahme." },
  aminos: { name: "Aminosäuren-Profil", material: "EDTA-Blut", reason: "Quantifizierung der essenziellen Aminosäuren zur Beurteilung der Proteinsynthese-Kapazität." },
  
  // ERWEITERT
  b12: { name: "Vitamin B12 (Holo-TC)", material: "Serum", reason: "Messung des biologisch aktiven B12 (Holo-Transcobalamin). Sensitiver als Gesamt-B12." },
  omega3: { name: "Omega-3 Index", material: "Erythrozyten", reason: "Bestimmung des Fettsäurestatus in der Zellmembran zur Einschätzung der Entzündungsregulation." },
  coq10: { name: "Coenzym Q10", material: "Serum/Vollblut", reason: "Messung des Spiegels zur Beurteilung der mitochondrialen Energieversorgung." },
  iod: { name: "Jod", material: "Serum oder Urin", reason: "Überprüfung der Jodversorgung. Relevanter Baustein für Schilddrüse und Brustgewebe." },
  vitaminA: { name: "Vitamin A (Retinol)", material: "Serum", reason: "Bestimmung bei Haut-/Schleimhautproblemen oder Nachtblindheit." },
  vitaminC: { name: "Vitamin C", material: "Vollblut (gefroren)", reason: "Bestimmung des Spiegels bei Infektneigung. Serum ist oft instabil." },
  
  // HORMONE & ORGANE
  thyroid: { name: "Schilddrüse (TSH, fT3, fT4, TPO)", material: "Serum", reason: "Umfassende Diagnostik: TSH allein reicht nicht. TPO zum Ausschluss von Autoimmunität (Hashimoto)." },
  adrenal: { name: "Cortisol-Tagesprofil & DHEA", material: "Speichel (Cortisol) / Serum (DHEA)", reason: "Beurteilung der Stresshormon-Rhythmik und Nebennierenrinden-Funktion." },
  hormonesF: { name: "Geschlechtshormone (E2, PG, FSH)", material: "Serum (21. Zyklustag)", reason: "Bestimmung des Hormonstatus und des Verhältnisses von Estradiol zu Progesteron." },
  hormonesM: { name: "Testosteron (Gesamt/Frei), SHBG", material: "Serum", reason: "Abklärung des Androgenstatus bei Antriebslosigkeit." },
  mangan: { name: "Mangan", material: "Vollblut", reason: "Messung der Versorgung. Wichtig für Bindegewebe und Histaminabbau." },
  chrom: { name: "Chrom", material: "Vollblut", reason: "Bestimmung bei Störungen des Zuckerstoffwechsels / Insulinresistenz." },
  molybdaen: { name: "Molybdän", material: "Vollblut", reason: "Überprüfung bei Harnsäure-Thematik." },
  kupfer: { name: "Kupfer", material: "Vollblut", reason: "Bestimmung zur Beurteilung des Zink-Kupfer-Verhältnisses und DAO-Funktion." },
  bor: { name: "Bor", material: "Vollblut", reason: "Messung bei Knochen-/Gelenkthemen und zur Beurteilung des Hormonstoffwechsels." },
  leber: { name: "Leberwerte (GOT, GPT, GGT)", material: "Serum", reason: "Kontrolle der Leberfunktion bei Medikamenteneinnahme oder Belastung." },
  lipoA: { name: "Lipoprotein (a)", material: "Serum", reason: "Einmalige Bestimmung des genetischen kardiovaskulären Risikofaktors." }
};

// --- LOGIK-ENGINE (LOKAL) ---
const runLocalAnalysis = (answers) => {
  let recs = [];
  const has = (id, val) => {
    const a = answers[id];
    if(!a) return false;
    if(Array.isArray(a)) return a.includes(val);
    return a === val;
  };

  // 1. BASIS
  recs.push(labParameters.vitaminD, labParameters.magnesium, labParameters.zink, labParameters.selen, labParameters.ferritin, labParameters.homocystein);

  // 2. STEALTH-HPU CHECK
  let hpuScore = 0;
  if(has(6, 'no_dreams')) hpuScore++;
  if(has(7, 'white_spots') || has(7, 'stretchmarks')) hpuScore++;
  if(has(9, 'hypermobile')) hpuScore++;
  if(has(10, 'hsp')) hpuScore++;
  if(has(12, 'morning_nausea')) hpuScore++;
  if(has(13, 'high_sensitive')) hpuScore++; 

  if (hpuScore >= 2) {
      recs.push(labParameters.b6); 
      recs.push(labParameters.mangan);
      recs.push(labParameters.zink);
  }

  // 3. POST-VIRAL
  if (has(8, 'postviral') || has(8, 'weak') || has(4, 'low')) {
     recs.push(labParameters.coq10);
     recs.push(labParameters.vitaminC);
     recs.push(labParameters.omega3);
     recs.push(labParameters.b12);
     if (has(1, 'young') || has(8, 'postviral')) recs.push(labParameters.ebv);
  }

  // 4. JUGENDLICHE / U30
  if (has(1, 'young')) {
    if (has(14, 'pill')) {
      recs.push(labParameters.b6);
      recs.push(labParameters.magnesium);
    }
    if (has(7, 'acne') || has(7, 'skin')) {
      recs.push(labParameters.vitaminA);
      recs.push(labParameters.zink);
    }
    if (has(15, 'focus') || has(15, 'fog') || has(10, 'adhs')) {
      recs.push(labParameters.omega3); 
      recs.push(labParameters.b6); 
      recs.push(labParameters.ferritin); 
      recs.push(labParameters.iod); 
    }
  }

  // 5. ALLGEMEINE LOGIK
  if(has(5,'vegan') || has(5,'veg') || has(5,'junk')) {
    recs.push(labParameters.b12, labParameters.iod, labParameters.aminos, labParameters.ferritin);
  }
  
  if(has(9,'muscle') || has(9,'growth')) recs.push(labParameters.magnesium, labParameters.mangan);
  if(has(9,'joint')) recs.push(labParameters.bor, labParameters.omega3);
  
  if(has(10,'depressive') || has(10,'stressed')) {
    recs.push(labParameters.b6, labParameters.omega3, labParameters.adrenal);
  }

  // Meds Check
  const medsText = (answers['14_text'] || "").toLowerCase();
  const freeText = (answers['25'] || "").toLowerCase();
  const allText = medsText + " " + freeText;

  if (allText.includes("akne") || has(14, 'acne_med')) recs.push(labParameters.leber);
  if (allText.includes("metformin")) recs.push(labParameters.b12);
  
  if(has(24, 'heart')) recs.push(labParameters.lipoA);

  if(has(1,'menopause') || has(1,'senior')) {
    if(has(2,'female')) recs.push(labParameters.hormonesF);
    if(has(2,'male')) recs.push(labParameters.hormonesM);
  }

  // Deduplizieren
  const unique = [];
  const map = new Map();
  for (const item of recs) {
    if(item && !map.has(item.name)){
      map.set(item.name, true);
      unique.push(item);
    }
  }
  return unique;
};


const NutrientGuideApp = () => {
  const [step, setStep] = useState(0);
  const [answers, setAnswers] = useState({});
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState(null);

  const handleAnswer = (qId, option) => {
    const q = questions.find(x => x.id === qId);
    if(q.multi) {
      setAnswers(prev => {
        const list = prev[qId] || [];
        if(option.exclusive) {
          const newState = {...prev, [qId]: [option.value]};
          delete newState[qId + '_text']; 
          return newState;
        }
        let newList = list.filter(v => {
           const o = q.options.find(opt => opt.value === v);
           return !o?.exclusive;
        });
        
        if(newList.includes(option.value)) newList = newList.filter(v => v !== option.value);
        else newList.push(option.value);
        
        return {...prev, [qId]: newList};
      });
    } else {
      setAnswers(prev => ({...prev, [qId]: option.value}));
      nextStep();
    }
  };

  const handleTextChange = (key, text) => {
    setAnswers(prev => ({ ...prev, [key]: text }));
  };

  const nextStep = () => {
    if(step < questions.length - 1) setStep(s => s + 1);
    else analyze();
  };

  const analyze = async () => {
    setLoading(true);
    setResult(null); 
    setErrorMsg(null);

    const localRecs = runLocalAnalysis(answers);
    const localSummary = "Ihr Profil deutet auf spezifische Stoffwechsel-Bedürfnisse hin. Aufgrund Ihrer Angaben sollten Sie neben den Basiswerten (Vit D, Magnesium, B12) besonders auf die Vollblut-Werte der Mineralstoffe achten.";

    if(!apiKey) {
      setTimeout(() => {
        setResult({ recommendations: localRecs, summary: localSummary, source: "Lokal" });
        setLoading(false);
      }, 800);
      return;
    }

    try {
      let profileText = "";
      questions.forEach(q => {
        let a = answers[q.id];
        let txt = answers[q.id + '_text'];
        if(Array.isArray(a)) a = a.join(", ");
        if(a || txt) profileText += `${q.text}: ${a || ''} ${txt ? `(${txt})` : ''}\n`;
      });

      const prompt = `
        Als Experte für funktionelle Labordiagnostik (Dr. Orfanos-Boeckel) erstelle eine Liste der notwendigen LABORUNTERSUCHUNGEN.
        
        WICHTIG:
        - Gib NUR DIAGNOSTISCHE Parameter aus (keine Therapieempfehlungen!).
        - Erkläre, WARUM gemessen werden soll (Begründung der Analyse).
        - Achte penibel auf das PROBENMATERIAL (Vollblut vs. Serum).
        
        Spezialfälle:
        - Post-Viral/Müdigkeit: EBV, Mitochondrien-Werte (Q10, B-Vit).
        - Junge Frauen: Ferritin!
        - Pille: B6, Mg, Zink Spiegel prüfen.
        
        Profil:
        ${profileText}
        
        Erstelle ein JSON Objekt:
        {
          "recommendations": [ 
            { 
              "name": "Name des Laborwerts (z.B. Zink)", 
              "material": "Material (z.B. Vollblut)", 
              "reason": "Begründung für die Messung (z.B. 'Ausschluss eines intrazellulären Mangels')" 
            } 
          ],
          "summary": "Persönliches Fazit zur Diagnostik."
        }
      `;

      const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });

      if(!resp.ok) {
        console.warn("KI nicht erreichbar, nutze lokale Logik.");
        setResult({ recommendations: localRecs, summary: localSummary, source: "Analyse (Lokal)" });
      } else {
        const data = await resp.json();
        let text = data.candidates[0].content.parts[0].text;
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) text = jsonMatch[0];
        const json = JSON.parse(text);
        setResult({ ...json, source: "Analyse (KI)" });
      }

    } catch (e) {
      console.error(e);
      setResult({ recommendations: localRecs, summary: localSummary, source: "Analyse (Lokal)" });
    } finally {
      setLoading(false);
    }
  };

  const q = questions[step];
  const progress = ((step + 1) / questions.length) * 100;
  const isSel = (val) => {
    const a = answers[q.id];
    return Array.isArray(a) ? a.includes(val) : a === val;
  };

  const restart = () => {
    setStep(0);
    setAnswers({});
    setResult(null);
  };

  if(loading) return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-emerald-50 text-emerald-800">
      <Loader2 className="w-16 h-16 animate-spin mb-4" />
      <h2 className="text-xl font-bold">Ermittle Laborparameter...</h2>
      <p className="text-sm opacity-75">Stelle Diagnostik-Profil zusammen</p>
    </div>
  );

  if(result) return (
    <div className="max-w-4xl mx-auto p-6 bg-gray-50 min-h-screen font-sans">
      <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
        <div className="bg-emerald-800 text-white p-8 text-center">
          <h1 className="text-3xl font-bold mb-2">Ihr Labor-Anforderungsschein</h1>
          <div className="flex items-center justify-center gap-2 opacity-80 text-sm">
            <Microscope className="w-4 h-4" />
            <span>Empfohlene Diagnostik ({result.source})</span>
          </div>
        </div>

        {errorMsg && (
          <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 m-6 text-yellow-800 flex items-center">
            <AlertCircle className="w-5 h-5 mr-2" />
            {errorMsg}
          </div>
        )}

        <div className="p-8">
          <div className="mb-10 bg-emerald-50 p-6 rounded-xl border border-emerald-100">
            <h3 className="text-xl font-bold text-emerald-900 mb-3 flex items-center">
              <MessageSquare className="w-5 h-5 mr-2" />
              Fazit zur Diagnostik
            </h3>
            <p className="text-emerald-800 leading-relaxed">
              {result.summary}
            </p>
          </div>

          <h3 className="text-xl font-bold text-gray-800 mb-6 flex items-center">
            <Activity className="w-5 h-5 mr-2 text-emerald-600" />
            Priorisierte Laborparameter
          </h3>
          
          <div className="space-y-4">
            {/* Header Row for Desktop */}
            <div className="hidden md:grid grid-cols-12 gap-4 px-4 py-2 bg-gray-100 rounded-lg text-sm font-bold text-gray-600 uppercase tracking-wider">
              <div className="col-span-4">Laborwert</div>
              <div className="col-span-3">Material</div>
              <div className="col-span-5">Begründung der Messung</div>
            </div>

            {result.recommendations.map((item, i) => (
              <div key={i} className="grid grid-cols-1 md:grid-cols-12 gap-4 p-4 border border-gray-200 rounded-lg bg-white hover:shadow-md transition-shadow items-start">
                <div className="col-span-1 md:col-span-4">
                  <span className="md:hidden text-xs font-bold text-gray-500 uppercase block mb-1">Laborwert</span>
                  <span className="font-bold text-gray-800 text-lg">{item.name}</span>
                </div>
                
                <div className="col-span-1 md:col-span-3">
                  <span className="md:hidden text-xs font-bold text-gray-500 uppercase block mb-1">Material</span>
                  <span className={`inline-block px-2 py-1 rounded text-xs font-bold uppercase tracking-wider ${
                    item.material?.toLowerCase().includes('voll') ? 'bg-red-100 text-red-700' : 
                    item.material?.toLowerCase().includes('speichel') ? 'bg-blue-100 text-blue-700' :
                    'bg-gray-100 text-gray-600'
                  }`}>
                    {item.material}
                  </span>
                </div>
                
                <div className="col-span-1 md:col-span-5">
                  <span className="md:hidden text-xs font-bold text-gray-500 uppercase block mb-1">Begründung</span>
                  <p className="text-sm text-gray-600 leading-relaxed">{item.reason}</p>
                </div>
              </div>
            ))}
          </div>

          <div className="mt-12 flex justify-center">
            <button 
              onClick={restart}
              className="flex items-center px-8 py-3 bg-gray-800 text-white rounded-full hover:bg-gray-700 transition-colors"
            >
              <RotateCcw className="w-4 h-4 mr-2" />
              Neue Analyse starten
            </button>
          </div>
        </div>
      </div>
    </div>
  );

  return (
    <div className="max-w-2xl mx-auto p-6 min-h-screen flex flex-col justify-center">
      <div className="mb-8">
        <div className="w-full bg-gray-200 h-2 rounded-full mb-4">
          <div className="bg-emerald-600 h-2 rounded-full transition-all duration-500" style={{width: `${progress}%`}}></div>
        </div>
        <div className="flex items-center justify-between">
          <span className="text-emerald-600 font-bold tracking-widest text-xs uppercase">Frage {step + 1} von {questions.length}</span>
          {answers[1] === 'young' && <span className="bg-emerald-100 text-emerald-700 text-xs px-2 py-1 rounded-full font-bold flex items-center"><GraduationCap className="w-3 h-3 mr-1"/> U30 Modus</span>}
        </div>
        <h2 className="text-3xl font-bold text-gray-900 mt-2">{q.text}</h2>
      </div>

      <div className="space-y-3">
        {q.type === 'text' ? (
          <textarea 
            className="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-0 h-40 text-lg transition-colors"
            placeholder={q.placeholder}
            value={answers[q.id] || ''}
            onChange={e => handleTextChange(q.id, e.target.value)}
          />
        ) : (
          q.options.map(opt => (
            <button
              key={opt.value}
              onClick={() => handleAnswer(q.id, opt)}
              className={`w-full text-left p-5 rounded-xl border-2 transition-all flex justify-between items-center group
                ${isSel(opt.value) 
                  ? 'border-emerald-500 bg-emerald-50 text-emerald-900' 
                  : 'border-gray-100 bg-white hover:border-emerald-200 text-gray-700 hover:bg-gray-50'
                }`}
            >
              <span className="font-medium text-lg">{opt.label}</span>
              {isSel(opt.value) && <CheckCircle className="w-6 h-6 text-emerald-500" />}
            </button>
          ))
        )}

        {q.hasFreeText && (
          <div className="mt-4 animate-fade-in">
            <label className="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2 block">Zusatzinfos</label>
            <div className="relative">
              <Pill className="absolute top-3 left-3 text-gray-400 w-5 h-5" />
              <input 
                type="text"
                className="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:border-emerald-500 transition-colors"
                placeholder={q.freeTextPlaceholder}
                value={answers[q.id + '_text'] || ''}
                onChange={e => handleTextChange(q.id + '_text', e.target.value)}
              />
            </div>
          </div>
        )}
      </div>

      {(q.multi || q.type === 'text') && (
        <button 
          onClick={nextStep}
          disabled={!answers[q.id] && !answers[q.id+'_text']}
          className="mt-8 w-full bg-emerald-600 text-white p-4 rounded-xl font-bold text-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl flex items-center justify-center"
        >
          {step === questions.length - 1 ? "Auswertung starten" : "Weiter"}
          <ArrowRight className="ml-2 w-5 h-5" />
        </button>
      )}
    </div>
  );
};

export default NutrientGuideApp;